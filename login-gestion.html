<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/polymerfire.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="login-signin.html">
<link rel="import" href="login-register.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">


<!--
`login-gestion`
elemento que nos permite hacer la gestion de los usuarios (login y cadastro) a través de Firebase

@demo demo/index.html 
-->

<dom-module id="login-gestion">
  <template>
    <style>
      :host {
         @apply(--layout-vertical);

        margin:auto;
         width: 400px;

      }
    </style>

    <firebase-app name="loginGestion"
                  auth-domain="logingestion.firebaseapp.com"
                  database-url="https://logingestion.firebaseio.com"
                  api-key="AIzaSyA9XQwWZbXlrOr8LntPQpfWfX6tGUNn5Xk">
    </firebase-app>

    <firebase-auth app-name="loginGestion"
                   id="auth" 
                   user="{{user}}" 
                   provider="{{provider}}"
                   signed-in="{{signedIn}}">
    </firebase-auth>
    <p>Usuario: {{user.displayName}}</p>
    <p>Email: {{user.email}}</p>

    

    <login-signin 
            on-sign-google="sign" 
            on-sign-email="email"
            signed-in="{{signedIn}}">
    </login-signin>

    <login-register 
            on-register="signUp" 
            signed-in="{{signedIn}}">
    </login-register>

    <paper-button on-tap="logout" raised>logout</paper-button>
    
    <paper-toast id="toast1" text="Ops!! hay un error"></paper-toast>
  
    
      
  </template>

  <script>
    Polymer({

      is: 'login-gestion',

      properties:{
          //propiedad bindeada al componente <firebase-auth> y que recibe seteada desde el componente <login-signin> los valores 'google', 'facebook' o twitter para loguearnos con una de estas redes
          provider:String,

          //objeto del usuario
          user:Object
      },

      // recibe como parámetro 'social' el dato recibido desde el componente <login-signin> al lanzar el evento. 'social' puede tener el valor 'google', 'facebook' o 'twitter' y este valor se seteará a la propiedad 'provider' bindeada al componente 'firebase-auth'
      sign:function(e,social){
        this.set('provider',social);
        this.$.auth.signInWithPopup().catch(function(error){
          console.log(error.code, error.message);
            switch (error.code){
            case 'auth/network-request-failed':
            alert('error de conexión. Por favor, intentar de nuevo')
            break
            case 'auth/too-many-requests':
            alert('demasiadas solicitaciones. Por favor, intentar más tarde')
            break
            case 'auth/user-disabled':
            alert('usuario no autorizado. Por favor, entrar en contacto via email')
            break
            case 'auth/user-token-expired':
            alert('Error. Por favor, intentar de nuevo')
            break
            case 'auth/user-token-expired':
            alert('Error. Por favor, intentar de nuevo')
            break
          }
        }).then(function(result){
          console.log('usuario ' + result.user.displayName +' logueado')
        });
      },
      
      // 
      logout:function(){
        this.$.auth.signOut().catch(function(error){
          console.log(error.code, error.message)
        }).then(function(){
          console.log('usuario deslogado')
        })
      },

      //método para crear un usuario con email y password. Estos dos datos serán propiedades del objeto 'data'

      signUp:function(e,data){
        this.$.auth.createUserWithEmailAndPassword(data.email, data.password).catch(function(error){
          console.log(error);
          switch (error.code){
            case 'auth/invalid-email':
            alert('email inválido')
            break
            case 'auth/weak-password':
            alert('el password debe tener mínimo 6 caracteres')
            break
            case 'auth/email-already-in-use':
            alert('ya existe ese email asociado a una cuenta')
            break
          }   
        }).then(function(user){
          console.log(user.email)
        });
      },
      
      //login con email y password; 'dato' es el objeto pasado por el componente <login-signin>, que incluye las propiedades 'dato.email' y 'dato.password'
      email:function(e,dato){
       
        this.$.auth.signInWithEmailAndPassword(dato.email, dato.password).catch(function(error){
          console.log(error.code, error.message);
             switch (error.code){
                case 'auth/invalid-email':
                alert('el email o el password son inválidos')
                break
                case 'auth/user-disabled':
                alert('usuario no autorizado. Por favor, entrar en contacto')
                break
                case 'auth/user-not-found':
                alert('no existe un usuario asociado a ese email')
                break
                case 'auth/wrong-password':
                alert('el email o el password son inválidos')
                break
          } 
          
            // no incluimos el selector $ para toast, desconozco por que
              this.toast1.open()
            
          
        })
      }


      
      

      


    });
  </script>
</dom-module>
