<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/polymerfire.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="login-signin.html">
<link rel="import" href="login-register.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">


<!--
`login-gestion`
elemento que nos permite hacer la gestion de los usuarios (login y cadastro) a través de Firebase

@demo demo/index.html 
-->

<dom-module id="login-gestion">
  <template>
    <style>
      :host {
         @apply(--layout-vertical);

        margin:auto;
         width: 400px;

      }
      #toastNegativo{
         --paper-toast-color:white;
         --paper-toast-background-color:#F50057;
         font-weight: bold
      }
    
    </style>

    <firebase-app name="loginGestion"
                  auth-domain="logingestion.firebaseapp.com"
                  database-url="https://logingestion.firebaseio.com"
                  api-key="AIzaSyA9XQwWZbXlrOr8LntPQpfWfX6tGUNn5Xk">
    </firebase-app>

    <firebase-auth app-name="loginGestion"
                   id="auth" 
                   user="{{user}}" 
                   provider="{{provider}}"
                   signed-in="{{signedIn}}">
    </firebase-auth>
    <p>Usuario: {{user.displayName}}</p>
    <p>Email: {{user.email}}</p>

    

    <login-signin 
            on-sign-google="sign" 
            on-sign-email="email"
            signed-in="{{signedIn}}">
    </login-signin>

    <login-register 
            on-register="signUp" 
            signed-in="{{signedIn}}">
    </login-register>

    <paper-button on-tap="logout" raised hidden$="{{!signedIn}}">logout</paper-button>
    
    <paper-toast id="toastPositivo"></paper-toast>
    <paper-toast id="toastNegativo"></paper-toast>
  
    
      
  </template>

  <script>
    Polymer({

      is: 'login-gestion',

      properties:{
          //propiedad bindeada al componente <firebase-auth> y que recibe seteada desde el componente <login-signin> los valores 'google', 'facebook' o twitter para loguearnos con una de estas redes
          provider:String,

          //objeto del usuario
          user:Object
      },

      listeners:{
            'feedback-positivo': 'feedbackPositivo',
            'feedback-negativo': 'feedbackNegativo'
      },

      // recibe como parámetro 'social' el dato recibido desde el componente <login-signin> al lanzar el evento. 'social' puede tener el valor 'google', 'facebook' o 'twitter' y este valor se seteará a la propiedad 'provider' bindeada al componente 'firebase-auth'
      sign:function(e,social){
        this.set('provider',social);
        this.$.auth.signInWithPopup().catch(function(error){
        //  console.log(error.code, error.message);
            switch (error.code){
            case 'auth/network-request-failed':
            this.fire('feedback-negativo','Error de conexión. Por favor, intentar de nuevo')
         //   alert('error de conexión. Por favor, intentar de nuevo')
            break
            case 'auth/too-many-requests':
             this.fire('feedback-negativo','Demasiadas solicitaciones. Por favor, intentar más tarde')
         //   alert('demasiadas solicitaciones. Por favor, intentar más tarde')
            break
            case 'auth/user-disabled':
            this.fire('feedback-negativo','usuario no autorizado. Por favor, entrar en contacto via email')
          //  alert('usuario no autorizado. Por favor, entrar en contacto via email')
            break
            case 'auth/user-token-expired':
            this.fire('feedback-negativo','Error. Por favor, intentar de nuevo')
          //  alert('Error. Por favor, intentar de nuevo')
            break
            case 'auth/user-token-expired':
            this.fire('feedback-negativo','Error. Por favor, intentar de nuevo')
          //  alert('Error. Por favor, intentar de nuevo')
            break
          }
        }.bind(this)).then(function(result){
          console.log('usuario ' + result.user.displayName +' logueado');
          console.log(result);
        });
      },
      
      // 
      logout:function(){
        this.$.auth.signOut().catch(function(error){
          console.log(error.code, error.message)
        }).then(function(){
          this.fire('feedback-positivo','has cerrado la sesión')
        }.bind(this))
      },
    

      //método para crear un usuario con email y password. Estos dos datos serán propiedades del objeto 'data'

      signUp:function(e,data){
        this.$.auth.createUserWithEmailAndPassword(data.email, data.password).catch(function(error){
        //  console.log(error);

          switch (error.code){
            case 'auth/invalid-email':
            this.fire('feedback-negativo','Email invalido')
          // alert('email inválido')
            break
            case 'auth/weak-password':
            this.fire('feedback-negativo','El password debe tener mínimo 6 caracteres')
           // alert('el password debe tener mínimo 6 caracteres')
            break
            case 'auth/email-already-in-use':
            this.fire('feedback-negativo','Ya existe ese email asociado a una cuenta')
           // alert('ya existe ese email asociado a una cuenta')
            break
          }   
        }.bind(this)).then(function(user){
          console.log(user.email);
          console.log(user);
        });
      },

         // método que lanza un toast con mensaje positivo. El mensaje de texto se pasa como parámetro a travès de la variable 'message'
      feedbackPositivo:function(e,message){
        this.$.toastPositivo.open();
        this.$.toastPositivo.text = message;
      },


        feedbackNegativo:function(e,message){
        this.$.toastNegativo.open();
        this.$.toastNegativo.text = message;
      },
      
      //login con email y password; 'dato' es el objeto pasado por el componente <login-signin>, que incluye las propiedades 'dato.email' y 'dato.password'
      email:function(e,dato){
       
        this.$.auth.signInWithEmailAndPassword(dato.email, dato.password).catch(function(error){
         // console.log(error.code, error.message);
             switch (error.code){
                case 'auth/invalid-email':
                this.fire('feedback-negativo','El email o el password son inválidos')
              //  alert('el email o el password son inválidos')
                break
                case 'auth/user-disabled':
                this.fire('feedback-negativo','Usuario no autorizado. Por favor, entrar en contacto')
              //  alert('usuario no autorizado. Por favor, entrar en contacto')
                break
                case 'auth/user-not-found':
                this.fire('feedback-negativo','No existe un usuario asociado a ese email')
              //  alert('no existe un usuario asociado a ese email')
                break
                case 'auth/wrong-password':
                this.fire('feedback-negativo','El email o el password son inválidos')
               // alert('el email o el password son inválidos')
                break
            }  
        }.bind(this)).then(function(user){
          console.log(user.email);
          console.log(user);
        });
      }

    });
  </script>
</dom-module>
